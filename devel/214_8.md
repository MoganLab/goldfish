# [214_8]

## 任务相关的代码文件
- bench/njson-bench.scm
- goldfish/liii/njson.scm
- src/goldfish.hpp
- tests/goldfish/liii/njson-test.scm
- devel/214_8.md

## 如何测试
```bash
xmake b goldfish
bin/goldfish tests/goldfish/liii/njson-test.scm
bin/goldfish bench/njson-bench.scm
```

## 2026/2/27 njson 命名简化、json njson 互转与格式化输出增强

### What
1. API 命名统一（Scheme 层）：
   - `njson-string->json` -> `string->njson`
   - `njson-file->json` -> `file->njson`
   - `njson-json->string` -> `njson->string`
   - `njson-json->file` -> `njson->file`
2. 新增 `liii json` 与 `liii njson` 双向转换 API：
   - `json->njson`
   - `njson->json`
3. 新增 JSON 文本格式化 API：
   - `njson-format-string`
   - 签名：`(njson-format-string json-string [indent])`，`indent` 默认 2。
4. `njson->file` 写入语义调整：
   - 从“直接写紧凑 JSON”改为“写入格式化后的 JSON 文本”。
5. 测试与基准同步更新：
   - `tests/goldfish/liii/njson-test.scm` 全量迁移新命名，并新增互转与格式化测试；
   - `bench/njson-bench.scm` 调用点全部切换到新 API 名称。

### Why
1. `njson` 命名与 `(liii json)` 统一后，学习与记忆成本更低（`string->json/json->string` 对应 `string->njson/njson->string`）。
2. 业务中常出现 `liii json` 与 `njson` 混用场景，缺少显式互转接口会导致调用方重复手写桥接逻辑。
3. 文件输出改为格式化文本后，更适合人读、日志排查和版本管理 diff。
4. 独立的 `njson-format-string` 能复用在文件输出、调试打印和测试断言中，避免散落格式化实现。

### How
1. `njson.scm` 统一导出新 API，并更新对应 `type-error` 提示文案。
2. `json->njson` 实现：
   - object/array：`liii-json->string` 后 `string->njson`；
   - scalar：复用 `njson->string` 再 `string->njson`。
3. `njson->json` 实现：
   - 为兼容 `liii json` 对“顶层 scalar 直接 parse”的限制，采用桥接对象方案：
     先构造 `{"__njson_bridge": <value>}` 再取该字段。
4. C++ 侧新增 `g_njson-format-string`（`f_njson_format_string`）：
   - 入参校验：`json-string` 必须是字符串，`indent` 必须是整数且 `>= 0`；
   - 执行路径：`json::parse` + `dump(indent)`；
   - 错误映射：`type-error` / `value-error` / `parse-error`。
5. `njson->file` 改为：
   - `path-write-text path (njson-format-string (njson->string x))`。

### 兼容性说明
1. 旧命名接口已不再导出，调用方需迁移到新命名。
2. `njson->file` 现在写入格式化 JSON，文件文本内容会变化（但 `file->njson` 读取语义不变）。
3. 互转 API 支持 object/array 与 strict scalar（string/number/boolean/'null）。
4. 已释放句柄、非法参数等错误类型仍保持既有风格（`type-error` / `value-error` / `parse-error`）。

## 验证结果
本次文档编写前已执行：
1. ✅ `xmake b goldfish` 通过。
2. ✅ `bin/goldfish tests/goldfish/liii/njson-test.scm` 通过（`; *** checks *** : 202 correct, 0 failed.`）。
3. ✅ `bin/goldfish bench/njson-bench.scm` 通过（`; *** checks *** : 29 correct, 0 failed.`）。
