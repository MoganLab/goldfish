# [214_5]

## 任务相关的代码文件
- goldfish/liii/njson.scm
- src/goldfish.hpp
- tests/goldfish/liii/njson-test.scm
- devel/214_5.md

## 如何测试
```bash
xmake b goldfish
bin/goldfish tests/goldfish/liii/njson-test.scm
```

## 2026/2/26 优化njson schema 校验 API 

### What
1. 明确 `njson-schema-report` 的报告协议（顶层 3 个字段）：
   - `valid?`：是否通过校验；
   - `error-count`：错误条数；
   - `errors`：错误明细列表。
2. 明确 `errors` 每项结构：
   - `instance-path`：失败位置（JSON Pointer）；
   - `message`：失败原因；
   - `instance`：触发失败的实例片段（JSON dump 字符串）。
3. C++ 侧实现分层：
   - `njson_collecting_error_handler` 负责采集底层 validator 错误；
   - `njson_schema_errors_to_scheme` 负责把 C++ 错误列表转成 Scheme list/hash-table；
   - `f_njson_schema_report` 负责组装最终报告。
4. 校验流程统一：
   新增 `njson_run_schema_validation`，统一处理参数转换、schema 装载、校验执行和异常映射。
5. 测试组织优化：
   `tests/goldfish/liii/njson-test.scm` 使用数据驱动方式验证报告准确性（shape case / error case / 异常 case）。

### Why
1. 报告字段固定后，调用方可以稳定提取 `valid? / error-count / errors` 做展示、日志和错误映射。
2. 错误项包含路径 + 原因 + 片段，能够直接支持定位失败字段而不是只拿到布尔值。
3. 统一报告协议后，测试可直接校验报告内容准确性，而不只是校验通过/失败。
4. 数据驱动测试能降低重复代码，新增 schema 场景时维护成本更低。

### How
1. 在 C++ 层由 `njson_collecting_error_handler::error(...)` 逐条收集校验错误：
   - `instance-path`
   - `message`
   - `instance`（dump 字符串）
2. `njson_run_schema_validation` 内统一执行校验主流程：
   - `scheme_to_njson_scalar_or_handle` 参数转换与类型错误映射；
   - `validator.set_root_schema(...)` 的 `schema-error` 映射；
   - `validator.validate(...)` 的 `validation-error` 映射。
3. `f_njson_schema_report` 只负责报告组装：
   - `valid? = errors.empty()`
   - `error-count = errors.size()`
   - `errors = njson_schema_errors_to_scheme(...)`
4. 测试层通过 `run-schema-report-shape-case`、`run-schema-report-error-case`、
   `check-schema-report-invalid-min-errors` 三类断言验证：
   - 顶层字段一致性；
   - 错误项字段准确性；
   - 多错误场景的稳健性（最小错误数断言）。

### 兼容性说明
1. `njson-schema-report` 报告协议以 `valid? / error-count / errors` 为准。
2. 历史字段 `'patch`、`'coverage-note` 不再提供。
3. 调用方应从 report 中读取 `(hash-table-ref report 'valid?)` 判断是否通过。
4. 类型错误、非法 schema、已释放句柄等异常语义保持原有错误类别（`type-error` / `schema-error` / `validation-error`）。

## 验证结果
本次文档编写前已执行：
1. ✅ `xmake b goldfish` 通过。
2. ✅ `bin/goldfish tests/goldfish/liii/njson-test.scm` 通过。
3. ✅ 输出：`; *** checks *** : 132 correct, 0 failed.`
