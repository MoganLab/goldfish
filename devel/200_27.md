# [200_27] 从 s7.c 拆分出 s7_liii_string.c 和 s7_liii_string.h

## 任务相关的代码文件
- src/s7.c
- src/s7_liii_string.c（新增）
- src/s7_liii_string.h（新增）
- xmake.lua
- devel/200_27.md

## 如何测试
```
xmake b goldfish
bin/goldfish tests/goldfish/liii/string-test.scm
```

### 验证结果
所有迁移函数均通过验证：
- ✅ 编译成功：`xmake b goldfish`
- ✅ 测试通过：`bin/goldfish tests/goldfish/liii/string-test.scm`（1560 个测试全部通过）

## 2026/02/25 将字符串函数从 s7.c 迁移到 s7_liii_string.c

### What
将以下字符串函数从 `s7.c` 迁移到 `s7_liii_string.c`：
1. `string-upcase` / `string-downcase`
2. `string-ref`
3. `string-set!`

具体工作包括：
1. 迁移 `g_string_upcase`、`g_string_downcase`、`g_string_ref`、`string_ref_1`、`g_string_set` 函数
2. 新增 `s7_liii_string.h`，补充迁移函数声明并与 `s7.c` 对接
3. 在 `s7.c` 中移除对应实现，改为包含 `s7_liii_string.h`
4. 在 `xmake.lua` 中新增 `src/s7_liii_string.c` 编译入口
5. 保持函数注册、优化路径和现有行为不变

### 依赖说明
迁移的函数依赖于以下 s7.c 内部机制：
- **字符串操作**：使用 s7 公开 API（`s7_is_string`, `s7_string_length`, `s7_string`, `s7_make_string_with_length`）
- **字符缓存 `chars[]`**：改为外部链接（非静态），供 `string_ref_1` 使用
- **大小写转换表 `lowers[]`/`uppers[]`**：改为外部链接（非静态），供 `g_string_upcase`/`g_string_downcase` 使用
- **类型错误处理**：使用 `s7_make_symbol` 动态获取符号，替代直接访问 `sc->xxx_symbol`
- **范围错误处理**：使用 `s7_out_of_range_error` 和 `s7_wrong_type_arg_error` 公开 API

### Why
将字符串相关函数从庞大的 `s7.c` 中拆分出来，有助于：
- 代码模块化，提高可维护性
- 便于后续字符串功能的扩展和优化
- 与 `(liii string)` 库的实现保持一致性

### How
**方案：保持独立（不迁移静态数据）**

由于 `lowers[]` 和 `uppers[]` 转换表还被其他函数使用（如 `scheme_strcasecmp`、`scheme_strequal_ci`、`hash_map_ci_string`、`char-downcase`），将这些数组保留在 `s7.c` 中，采用以下方案：

1. **创建 `s7_liii_string.h` 头文件**，声明需要导出的函数
2. **创建 `s7_liii_string.c` 实现文件**，包含 `g_string_upcase` 和 `g_string_downcase` 的实现
   - 使用 s7 公开 API（`s7_is_string`, `s7_string_length`, `s7_string`, `s7_make_string_with_length` 等）
   - 通过 `extern` 声明引用 `s7.c` 中的 `lowers[]` 和 `uppers[]` 数组
   - 类型检查错误处理使用 `s7_make_symbol` 动态获取符号
3. **修改 `s7.c`**：
   - 将 `lowers[]` 和 `uppers[]` 从 `static` 改为非静态（外部链接）
   - 移除原函数实现，改为包含 `s7_liii_string.h`
   - 函数注册改为直接使用 `s7_define_typed_function`（不再依赖 `defun` 宏的 `H_`/`Q_` 宏）
4. **更新 `xmake.lua`** 添加新文件的编译

### 关键技术点
- **s7_scheme 不透明类型**：无法直接访问 `sc->xxx_symbol`，改用 `s7_make_symbol(sc, "name")`
- **静态数组共享**：将 `lowers[]`/`uppers[]` 改为非静态，使外部文件可链接
- **宏依赖处理**：`LOOP_8` 宏在 `s7_liii_string.c` 中重新定义
