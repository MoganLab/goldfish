# [214_3]

## 任务相关的代码文件
- goldfish/liii/njson.scm
- tests/goldfish/liii/njson-test.scm
- devel/214_3.md

## 如何测试
```bash
bin/goldfish tests/goldfish/liii/njson-test.scm
```

## 2026/2/25 njson 作用域宏收敛为 let-njson

### What
1. `goldfish/liii/njson.scm`：
   仅导出 `let-njson` 作为作用域自动释放宏，移除 `njson-with-json` 与 `njson-with-value`。
2. 宏实现重构：
   保留并复用 `njson%%single-binding?`、`njson%%binding-list?`、
   `njson%%normalize-bindings`、`njson%%expand-with-value-bindings`，
   统一绑定解析和展开路径。
3. 宏卫生与语法校验：
   `let-njson` 在展开阶段使用 `gensym("njson-released?")` 生成临时变量；
   绑定列表要求非空，`(let-njson ())` 抛 `type-error`。
4. `tests/goldfish/liii/njson-test.scm`：
   由“直接句柄 + 手动 free”为主的写法，调整为“按 API 分段 + 作用域宏”为主；
   增加块注释文档，测试组织方式参考 `json-test.scm`；
   将所有宏调用统一替换为 `let-njson`，并在字符串输入场景显式调用 `njson-string->json`。
5. 测试补充：
   新增 `let-njson` 空绑定报错用例；
   保留并加强多绑定成功路径、解析失败路径、业务异常路径自动释放验证。

### Why
1. 之前 `define-macro` 展开中使用固定局部名，存在非卫生宏变量捕获风险。
2. 绑定解析逻辑在两个宏中重复，维护成本高。
3. 空绑定默认可执行 body 的行为不够严格，不利于快速暴露调用错误。
4. `njson-test.scm` 之前手动资源释放与用例组织不统一，可读性和维护性较弱。
5. 需要明确验证“多 JSON 同时绑定 + 自动释放 + 异常安全”。

### How
1. 先通过 `njson%%normalize-bindings` 将输入统一为绑定列表（或 `#f`）。
2. 字符串输入场景在 `let-njson` 绑定中显式转换：
   `(var (njson-string->json json-string))`。
3. `njson%%expand-with-value-bindings` 递归生成嵌套 `let + dynamic-wind`：
   左到右获取资源，右到左释放资源；标量值直接透传。
4. 释放阶段使用 `catch 'type-error` 忽略重复 free 导致的清理路径异常。
5. `njson-test.scm` 采用分组注释 + 多绑定宏写法，并保留基准段手动 free，
   避免将宏开销混入性能对比统计口径。

### 兼容性说明
1. API 变更：`njson-with-json` 与 `njson-with-value` 不再提供，统一使用 `let-njson`。
2. 字符串输入需显式写 `njson-string->json`，不再有单独 `with-json` 语法糖。
3. 行为保持：空绑定列表继续抛 `type-error`，自动释放与异常安全语义保持不变。

## 验证结果
本次文档编写前已执行：
1. ✅ `bin/goldfish tests/goldfish/liii/njson-test.scm` 通过。
2. ✅ 输出：`; *** checks *** : 90 correct, 0 failed.`
